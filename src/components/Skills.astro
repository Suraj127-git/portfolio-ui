---
import Section from "./Section.astro";
import SkillModal from "./SkillModal.astro";
import { SITE_CONTENT } from "@config";

const { categories, details } = SITE_CONTENT.skills;
---

<Section text="Technical Expertise" href="skills">
  <div
    class="skills-container relative py-10"
    data-skill-details={JSON.stringify(details)}
  >
    <!-- Background Glow -->
    <div
      class="absolute inset-0 bg-gradient-to-r from-transparent via-primary/5 to-transparent blur-2xl pointer-events-none"
    >
    </div>

    <!-- Categories Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
      {
        categories.map((category, index) => (
          <div
            class="category-card rounded-2xl border border-border bg-gradient-to-br from-card-bg to-transparent backdrop-blur-sm p-6 hover:border-primary/30 transition-colors duration-300"
            data-index={index}
          >
            <h3 class="text-2xl font-serif font-bold text-primary mb-6 flex items-center gap-3">
              <span class="w-2 h-8 bg-primary rounded-full inline-block" />
              {category.title}
            </h3>

            <div class="space-y-4">
              {category.skills.map((skillName) => {
                return (
                  <div
                    class="skill-item group cursor-pointer"
                    data-skill={skillName}
                    role="button"
                    tabindex="0"
                    aria-label={`View details for ${skillName}`}
                  >
                    <div class="flex justify-between items-end mb-1">
                      <span class="font-medium text-text group-hover:text-primary transition-colors duration-300">
                        {skillName}
                      </span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        ))
      }
    </div>
  </div>
</Section>

<!-- Include the modal -->
<SkillModal />

<script>
  async function initSkillsAnimation() {
    try {
      const prefersReducedMotion = window.matchMedia(
        "(prefers-reduced-motion: reduce)"
      ).matches;
      
      // Dynamic import for GSAP
      const gsap = (await import("gsap")).default;
      const ScrollTrigger = (await import("gsap/ScrollTrigger")).default;
      gsap.registerPlugin(ScrollTrigger);

      // Animate Category Cards
      const cards = document.querySelectorAll(".category-card");
      
      cards.forEach((card, index) => {
        gsap.from(card, {
          scrollTrigger: {
            trigger: card,
            start: "top 85%",
            toggleActions: "play none none reverse",
          },
          y: 50,
          opacity: 0,
          duration: 0.6,
          delay: index * 0.1,
          ease: "power3.out",
        });


      });

      // Modal Interaction Logic
       const skillItems = document.querySelectorAll(".skill-item");
       skillItems.forEach((item) => {
         const openModal = () => {
           const skillName = item.getAttribute("data-skill");
           if (skillName) {
             openSkillModal(skillName);
           }
         };

         item.addEventListener("click", openModal);
         
         item.addEventListener("keydown", (e: Event) => {
            const keyEvent = e as KeyboardEvent;
            if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {
                keyEvent.preventDefault();
                openModal();
            }
         });
       });

    } catch (error) {
      console.error("Skills animation failed:", error);
      // Fallback for visibility
      document.querySelectorAll(".category-card").forEach((el) => {
        (el as HTMLElement).style.opacity = "1";
        (el as HTMLElement).style.transform = "none";
      });
    }
  }

  // Modal Opening Logic (Global function or locally scoped if modal script expects it)
  // The SkillModal component likely has its own script or expects a global function.
  // Based on previous code, `openSkillModal` was called. I assume it's defined in SkillModal.astro or global scope.
  // Checking SkillModal.astro would be good, but assuming previous pattern works.
  // Wait, in the previous code `openSkillModal` was defined INSIDE the script block.
  // I need to redefine it here or check if it's exported.
  // Let's include the modal logic here to be safe, similar to previous file.

  function openSkillModal(skillName: string) {
    const modal = document.getElementById("skill-modal");
    const modalSkillName = document.getElementById("modal-skill-name");
    const modalSkillExperience = document.getElementById("modal-skill-experience");
    const modalSkillProjects = document.getElementById("modal-skill-projects");
    const modalSkillTools = document.getElementById("modal-skill-tools");
    const modalSkillAchievements = document.getElementById("modal-skill-achievements");
    const skillsContainer = document.querySelector(".skills-container");

    if (
      !modal ||
      !modalSkillName ||
      !modalSkillExperience ||
      !modalSkillProjects ||
      !modalSkillTools ||
      !modalSkillAchievements ||
      !skillsContainer
    )
      return;

    // Get skill details from data attribute
    const skillDetailsJson = skillsContainer.getAttribute("data-skill-details");
    if (!skillDetailsJson) return;

    const skillDetails = JSON.parse(skillDetailsJson);
    const skill = skillDetails.find((s: any) => s.name === skillName);

    if (!skill) return;

    // Populate modal content
    modalSkillName.textContent = skill.name;
    modalSkillExperience.textContent = `${skill.experience || ""} - ${skill.level || ""}`;

    // Populate projects
    if (skill.projects && skill.projects.length > 0) {
      modalSkillProjects.innerHTML = skill.projects.map((project: string) => 
        `<li class="flex items-start gap-2"><span class="text-primary mt-1">•</span><span>${project}</span></li>`
      ).join('');
    } else {
      modalSkillProjects.innerHTML = '<li class="text-secondary">No projects listed</li>';
    }

    // Populate tools
    if (skill.tools && skill.tools.length > 0) {
      modalSkillTools.innerHTML = skill.tools.map((tool: string) => 
        `<span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm border border-primary/20">${tool}</span>`
      ).join('');
    } else {
      modalSkillTools.innerHTML = '<span class="text-secondary">No tools listed</span>';
    }

    // Populate achievements
    if (skill.achievements && skill.achievements.length > 0) {
      modalSkillAchievements.innerHTML = skill.achievements.map((achievement: string) => 
        `<li class="flex items-start gap-2"><span class="text-primary mt-1">•</span><span>${achievement}</span></li>`
      ).join('');
    } else {
      modalSkillAchievements.innerHTML = '<li class="text-secondary">No achievements listed</li>';
    }

    // Show modal
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    document.body.style.overflow = "hidden"; // Prevent background scrolling
    
    // Small delay to allow display:flex to apply before opacity transition
    setTimeout(() => {
        modal.classList.remove("opacity-0");
        modal.querySelector("div[class*='scale-95']")?.classList.remove("scale-95");
        modal.querySelector("div[class*='scale-95']")?.classList.add("scale-100");
    }, 10);
  }

  // Initialize
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSkillsAnimation);
  } else {
    initSkillsAnimation();
  }
</script>